#!/usr/bin/env node

/**
 * Module dependencies.
 */

var server = require('../lib/server')
  , client = require('../lib/client')
  , program = require('commander')
  , pkg = require('../package')
  , s = require('printf')
  , ms = require('ms');

// options

program
  .version(pkg.version)
  .option('-a, --addr <addr>', 'bind address [0.0.0.0]', '0.0.0.0')
  .option('-l, --cycles', 'list cycles')
  .option('-c, --cycle <cycle>', 'get <cycle>')
  .option('-j, --json', 'output json')
  .option('--clear-all', 'clear all traces')
  .parse(process.argv);

// title

process.title = 'trace';

/**
 * JSON helper.
 */

function json(obj) {
  console.log(JSON.stringify(obj, null, 2));
  process.exit(0);
}

// --cycles

if (program.cycles) {
  return client.cycles(function(err, names){
    if (err) throw err;
    if (program.json) return json(names);
    names.forEach(function(name){
      console.log(name);
    });
    process.exit(0);
  });
}

// --cycle <cycle>

if (program.cycle) {
  if (program.json) {
    return client.get(program.cycle, function(err, data){
      if (err) throw err;
      json(data);
    });
  }

  return client.stats(program.cycle, function(err, stats){
    for (var name in stats.probes) {
      console.log();
      console.log(s('  \033[36m%13s\033[0m', name));
      for (var metric in stats.probes[name]) {
        var val = stats.probes[name][metric];
        console.log(s('    \033[90m%10s:\033[0m %s', metric, ms(val)));
      }
    }
    console.log();
    process.exit(0);
  });
}

// --clear-all

if (program.clearAll) {
  return client.clearAll(function(err){
    if (err) throw err;
    process.exit(0);
  });
}

// bind

var addr = 'tcp://' + program.addr + ':5555';
server.sub.bind(addr);
console.log('sub bound to %s', addr);

var addr = 'tcp://' + program.addr + ':5556';
server.rep.bind(addr);
console.log('rep bound to %s', addr);
